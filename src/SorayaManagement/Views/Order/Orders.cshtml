@model List<SorayaManagement.ViewModels.GetOrderViewModel>;

@{
    ViewData["Title"] = "Pedidos";
    Layout = "_Layout";
}

@await Component.InvokeAsync("Menu")

<section class="container">

    <div class="row">
        <div class="col-md-6">
            <a class="btn btn-primary-custom mb-3" asp-area="" asp-controller="Order" asp-action="Create">Novo
                Pedido</a>
        </div>
    </div>

    <div class="">
        <form id="filterForm" asp-controller="Order" asp-action="Orders" method="GET">
            <div class="justify-content-end row">
                <div class="col-md-3">
                    <label for="isPaid" class="form-label fw-bolder">Filtrar por pagamento:</label>
                    <select id="isPaid" name="isPaid" class="form-select form-control" style="width: 250px;">
                        <option>Selecione alguma opção</option>
                        <option value="all">Todos</option>
                        <option value="true">Pagos</option>
                        <option value="false">Não Pagos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="createdAt" class="form-label fw-bolder">Filtrar por data:</label>
                    <input id="createdAt" name="createdAt" type="date" class="form-control">
                </div>
            </div>
        </form>
    </div>

    <table id="ordersTable" class="table styled-table">
        <caption><b>@Model.Count</b> Pedidos Encontrados.</caption>
        <thead>
            <tr>
                <th></th>
                <th>Cliente</th>
                <th>Sabor</th>
                <th>Valor</th>
                <th>Forma de Pagamento</th>
                <th>Pago</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="ordersTableBody" class="table-group-divider">
            @foreach (var order in Model)
            {
                <tr>
                    <th>
                        <a asp-action="Details" asp-route-orderId="@order.Id">
                            <i class="fa-solid fa-circle-info fa-lg"></i>
                        </a>
                    </th>
                    <td>@order.Customer</td>
                    <td>@order.Meal</td>
                    <td><b>R$</b> @Math.Round(@order.Price, 2)</td>
                    <td>
                        @if (@order.PaymentType.Equals("PIX"))
                        {
                            <p><img class="payment-type-icons" src="~/img/pix.svg" alt="PIX" /> @order.PaymentType</p>
                        }
                        else
                        {
                            <p><img class="payment-type-icons" src="~/img/money.svg" alt="Money" /> @order.PaymentType</p>
                        }
                    </td>
                    <td>
                        @if (!order.IsPaid)
                        {
                            <form asp-action="MarkOrderAsPaid" method="post">
                                <input type="hidden" name="orderId" value="@order.Id" />
                                <button type="submit" class="btn btn-sm btn-success">Marcar como Pago</button>
                            </form>
                        }
                        else
                        {
                            <i id="checkIcon" class="fa-solid fa-square-check fa-xl"></i>
                        }
                    </td>
                </tr>
            }
            <tr>
                <td colspan="4">
                    <table id="ordersInfoTable" class="table mb-0">
                        <thead>
                            <th>Total de lucro do Dia: </th>
                            <th>Total de vendas: </th>
                        </thead>
                        <tbody id="ordersInfoTableBody">
                            <td>
                                <h2><b>R$ @Math.Round(
                                        @Model.Where(x => x.IsPaid == true)
                                        .Select(x => x.Price)
                                        .Sum(), 2)</b></h2>
                            </td>
                            <td>
                                <h2><b>@Model.Where(x => x.IsPaid == true).Select(x => x.Id).Count()</b></h2>
                            </td>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>

</section>

<script>
    $(document).ready(function () {
        $('#filterForm').change(function (e) {
            e.preventDefault();

            var formData = $(this).serialize();

            $.ajax({
                url: '/pedidos/filtering',
                type: 'GET',
                data: formData,
                success: function (result) {
                    $('#ordersTableBody').html(result);
                },
                error: function () {
                    alert(`Ocorreu um erro ao processar a solicitação.`);
                }
            });
        });
    });
</script>